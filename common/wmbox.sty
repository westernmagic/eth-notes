\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{wmbox}

\RequirePackage{xparse}
\RequirePackage{xkeyval}
\RequirePackage{xifthen}
\RequirePackage{hopatch}
\hopatch@AfterPackage{makecmds}{
	\makecommand*\renewlength[2]{\setlength#1{#2}}
	\makecommand*\makelength[2]{
		\providelength{#1}
		\renewlength{#1}{#2}
	}
}
\RequirePackage{makecmds}
\RequirePackage[usenames]{xcolor}
\RequirePackage{boites}

\newbox\wm@inputbox
\newbox\wm@currentbox

\DeclareDocumentCommand{\wm@putbox}{m}{
	\makelength{\wm@boxvspace}{\ht#1 + \dp#1}
	\addtolength{\wm@boxvspace}{2cm}
	
	\ifthenelse{\lengthtest{\pagegoal = \maxdimen}}{
		\makelength{\wm@freevspace}{\vsize}
	}{
		\makelength{\wm@freevspace}{\pagegoal - \pagetotal}
	}
	
	\ifthenelse{\lengthtest{\wm@boxvspace < \wm@freevspace}}{
		\setbox\wm@currentbox=\vbox{\unvbox#1}
		\wm@box{yellow}{black}{\wm@currentbox}
	}{
		\makelength{\wm@boxht}{\wm@freevspace}
		\addtolength{\wm@boxht}{-2cm}
		\addtolength{\wm@boxht}{-\pageshrink}
		\boxmaxdepth=\z@
		\splittopskip=\z@
		\splitmaxdepth=\z@
		\setbox\wm@currentbox=\vsplit#1 to \wm@boxht
		\setbox\wm@currentbox=\vbox{\unvbox\wm@currentbox}
		\wm@box{yellow}{black}{\wm@currentbox}
		\clearpage
		\wm@putbox{#1}
	}
}

\newlength{\wmbox@totaltopskip}
\newlength{\wmbox@totalbottomskip}
\wmbox@totaltopskip=\z@
\wmbox@totalbottomskip=\z@


\define@cmdkeys{wmbox}{
	innerleftmargin ,
	innerrightmargin ,
	innertopmargin ,
	innerbottommargin ,
	leftmargin ,
	rightmargin ,
	skipabove ,
	skipbelow ,
	splittopskip ,
	splitbottomskip ,
	backgroundcolor ,
	fontcolor
}{}

\setkeys{wmbox}{
	innerleftmargin   = 1cm ,
	innerrightmargin  = 1cm ,
	innertopmargin    = 1cm ,
	innerbottommargin = 1cm ,
	leftmargin        = 0cm ,
	rightmargin       = 0cm ,
	skipabove         = 0cm ,
	skipbelow         = 0cm ,
	splittopskip      = 0cm ,
	splitbottomskip   = 0cm ,
	backgroundcolor   = white ,
	fontcolor         = black
}

\DeclareDocumentCommand{\wm@box}{O{} m m m}{
	\setkeys{wmbox}{#1}
	\setlength{\hsize}{#2}
	\leftline{
%		\null
		\hspace*{-12pt}
		\rlap{
			\color{\cmdKV@wmbox@backgroundcolor}
			\rule[-\cmdKV@wmbox@innertopmargin]{\wd#4+\cmdKV@wmbox@innerleftmargin+\cmdKV@wmbox@innerleftmargin}{\ht#4+\cmdKV@wmbox@innertopmargin+\cmdKV@wmbox@innerbottommargin}
		}
		\hspace*{\cmdKV@wmbox@innerleftmargin}
		{
			\setlength{\hsize}{#3}
			\color{\cmdKV@wmbox@fontcolor}
			\noindent
			\box#4
		}
	}
}

\DeclareDocumentCommand{\wmbox}{O{} +m}{
	\setkeys{wmbox}{#1}
	\advance\wmbox@totaltopskip \cmdKV@wmbox@innertopmargin
	\advance\wmbox@totalbottomskip \cmdKV@wmbox@innerbottommargin
	\makelength{\oldhsize}{\hsize}
	\makelength{\newhsize}{\hsize}
	\setlength{\newhsize}{\newhsize - \cmdKV@wmbox@innerleftmargin - \cmdKV@wmbox@innerrightmargin}
	\setlength{\hsize}{\newhsize}
	\setbox\wm@inputbox = \vbox{#2}
	\ifthenelse{\lengthtest{\pagegoal = \maxdimen}}{
		\makelength{\wm@freevspace}{\vsize}
	}{
		\makelength{\wm@freevspace}{\pagegoal - \pagetotal}
	}
	\whiledo{\lengthtest{\wm@freevspace < \ht\wm@inputbox}}{
		\addtolength{\wm@freevspace}{-\wmbox@totaltopskip - \wmbox@totalbottomskip}
		\setlength{\hsize}{\newhsize}
		\setbox\wm@currentbox = \vsplit\wm@inputbox to \wm@freevspace
		\wm@box[#1]{\oldhsize}{\newhsize}{\wm@currentbox}
		\penalty0
		\makelength{\wm@freevspace}{\vsize - \wmbox@totaltopskip - \wmbox@totalbottomskip }
	}
	\wm@box[#1]{\oldhsize}{\newhsize}{\wm@inputbox}
	\advance\wmbox@totaltopskip -\cmdKV@wmbox@innertopmargin
	\advance\wmbox@totalbottomskip -\cmdKV@wmbox@innerbottommargin
	\setlength{\hsize}{\oldhsize}
}

